<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV 在线播放器</title>
    <!-- 引用库文件 -->
    <script src="/static/js/hls.js"></script>
    <script src="/static/js/mpegts.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            --header-bg: rgba(255, 255, 255, 0.95);
            --accent-color: #0575E6;
            --accent-gradient: linear-gradient(135deg, #00f260 0%, #0575E6 100%);
            --text-main: #2d3436;
            --text-dim: #636e72;
            --border-color: rgba(0, 0, 0, 0.05);
            --hover-bg: rgba(5, 117, 230, 0.08);
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: "Microsoft YaHei", sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, hsla(253,16%,7%,0) 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0.1) 0, hsla(225,39%,30%,0) 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0.1) 0, hsla(339,49%,30%,0) 50%);
        }

        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255,255,255,0.5);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            z-index: 10;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border-bottom: 1px solid var(--border-color);
        }

        .tab-buttons {
            display: flex;
            background: #dfe6e9;
            border-radius: 8px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #fff;
            color: var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .search-container {
            padding: 10px 15px;
        }

        .search-box {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            background: rgba(255,255,255,0.8);
            font-weight: 500;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s;
        }

        .search-box:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(5, 117, 230, 0.1);
            background: #fff;
        }

        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        .channel-list, .epg-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #b2bec3; border-radius: 3px; }

        .channel-group {
            padding: 12px 15px;
            font-size: 0.85rem;
            color: var(--accent-color);
            font-weight: 700;
            background: rgba(255, 255, 255, 0.9);
            position: sticky;
            top: 0;
            backdrop-filter: blur(5px);
            z-index: 5;
            border-bottom: 1px solid var(--border-color);
        }

        .channel-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }

        .channel-item:hover { background: var(--hover-bg); padding-left: 20px; }
        .channel-item.active { background: var(--accent-gradient); color: white; box-shadow: 0 4px 10px rgba(5, 117, 230, 0.3); }

        .program-item { padding: 15px; border-bottom: 1px solid var(--border-color); position: relative; }
        .program-time { font-size: 0.85rem; color: var(--accent-color); margin-bottom: 4px; font-weight: bold; }
        .program-title { font-weight: 600; line-height: 1.4; }
        .current-program { background: #e3f2fd; border-left: 4px solid var(--accent-color); }

        .main { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
        .header {
            height: 60px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 25px;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            z-index: 20;
        }

        #currentChannelName { font-size: 1.2rem; font-weight: 700; color: #2d3436; }
        .controls { display: flex; align-items: center; gap: 15px; }
        
        .control-input {
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #dfe6e9;
            font-size: 0.85rem;
            width: 200px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .control-input:focus { width: 250px; border-color: var(--accent-color); background: #fff; outline: none; }

        .btn {
            padding: 8px 16px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(5, 117, 230, 0.25); }
        .btn-secondary { background: #dfe6e9; color: var(--text-main); }

        .video-container { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; max-height: calc(100vh - 60px); outline: none; }

        .toggle-switch { display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; color: var(--text-dim); }
        .toggle-switch input { margin-right: 8px; accent-color: var(--accent-color); }

        @media (max-width: 768px) {
            .sidebar { position: absolute; left: -320px; top: 0; bottom: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .sidebar.open { transform: translateX(320px); }
            #sidebar-toggle { display: block !important; margin-right: 15px; color: var(--text-main); background: none; border: none; font-size: 1.5rem; }
            .control-input { display: none; }
            #currentChannelName { font-size: 1rem; }
            .header { padding: 0 15px; }
            .btn { padding: 6px 12px; font-size: 0.8rem; }
        }
    </style>
</head>

<body>
    <div id="sidebar-overlay" onclick="toggleSidebar()" style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.3); z-index:9; display:none;"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('channels')" id="btn-channels">
                    <i class="bi bi-list-ul"></i> 频道列表
                </button>
                <button class="tab-btn" onclick="switchTab('epg')" id="btn-epg">
                    <i class="bi bi-calendar-event"></i> 节目单
                </button>
            </div>
        </div>

        <div id="tab-channels" class="tab-content active">
            <div class="search-container">
                <input type="text" class="search-box" placeholder="搜索频道..." onkeyup="filterChannels(this.value)">
            </div>
            <div class="channel-list" id="channelList">
                <div style="padding: 30px; text-align: center; color: var(--text-dim);">
                    <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;"></div>
                    <div style="margin-top: 10px;">正在加载...</div>
                </div>
            </div>
        </div>

        <div id="tab-epg" class="tab-content">
            <div class="epg-list" id="epgPanel">
                <div style="padding: 40px 20px; text-align: center; color: var(--text-dim);">
                    <i class="bi bi-tv" style="font-size: 2rem; display: block; margin-bottom: 10px;"></i>
                    请先选择一个频道<br>以查看节目信息
                </div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <button id="sidebar-toggle" style="display:none;" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                <div id="currentChannelName">IPTV 播放器</div>
            </div>
            
            <div class="controls">
                <label class="toggle-switch" title="开启跨域代理">
                    <input type="checkbox" id="useProxy"> <span>代理</span>
                </label>
                
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="epgUrl" class="control-input" placeholder="XMLTV EPG 地址..." value="{{ epg_url }}">
                    <button class="btn" onclick="setEPG()">加载 EPG</button>
                </div>
                
                <a href="/subscriptions" class="btn btn-secondary">
                    <i class="bi bi-box-arrow-right"></i> 退出
                </a>
            </div>
        </div>

        <div class="video-container">
            <video id="video" controls autoplay playsinline></video>
        </div>
    </div>

    <script>
        let hls;
        let allChannels = [];
        let currentGroup = '';

        window.onload = function () {
            const params = new URLSearchParams(window.location.search);
            const playlistUrl = params.get('url');
            const playlistName = params.get('name');

            if (playlistName) document.title = `${playlistName} - IPTV 播放器`;

            const serverEpg = document.getElementById('epgUrl').value;
            const savedEpg = localStorage.getItem('epg_url');
            if (!serverEpg && savedEpg) {
                document.getElementById('epgUrl').value = savedEpg;
            }

            if (playlistUrl) {
                loadPlaylist(playlistUrl);
            } else {
                document.getElementById('channelList').innerHTML = 
                    '<div style="padding:40px; text-align:center; color:#999;">请从订阅页面选择播放</div>';
            }
        };

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
        }

        function loadPlaylist(url) {
            fetch(url)
                .then(r => r.text())
                .then(text => {
                    allChannels = parsePlaylist(text);
                    renderChannels(allChannels);
                    if (allChannels.length > 0) {
                        document.getElementById('currentChannelName').textContent = "准备就绪";
                    } else {
                        alert("播放列表为空");
                    }
                })
                .catch(e => alert("无法加载播放列表: " + e));
        }

        function parsePlaylist(content) {
            if (content.indexOf('#EXTM3U') !== -1 || content.indexOf('#EXTINF') !== -1) {
                return parseM3U(content);
            } else {
                return parseTXT(content);
            }
        }

        function parseTXT(content) {
            const lines = content.split('\n');
            const channels = [];
            let currentGroup = '其他频道';

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                if (line.includes(',#genre#')) {
                    currentGroup = line.split(',')[0].trim();
                } else {
                    const commaIdx = line.indexOf(',');
                    if (commaIdx !== -1) {
                        const name = line.substring(0, commaIdx).trim();
                        const url = line.substring(commaIdx + 1).trim();
                        channels.push({ name: name, group: currentGroup, url: url });
                    }
                }
            });
            return channels;
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            let current = {};

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                if (line.startsWith('#EXTINF')) {
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    const idMatch = line.match(/tvg-id="([^"]*)"/);
                    const nameParts = line.split(',');
                    const name = nameParts[nameParts.length - 1].trim();
                    current = {
                        name: name,
                        group: groupMatch ? groupMatch[1] : '其他频道',
                        logo: logoMatch ? logoMatch[1] : null,
                        id: idMatch ? idMatch[1] : null,
                        url: null
                    };
                } else if (!line.startsWith('#')) {
                    if (current.name) {
                        current.url = line;
                        channels.push(current);
                        current = {};
                    }
                }
            });
            return channels;
        }

        function renderChannels(channels) {
            const container = document.getElementById('channelList');
            container.innerHTML = '';

            const groups = {};
            channels.forEach((ch, idx) => {
                if (!groups[ch.group]) groups[ch.group] = [];
                groups[ch.group].push({ ...ch, index: idx });
            });

            for (const [groupName, groupChannels] of Object.entries(groups)) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'channel-group';
                groupDiv.textContent = groupName;
                container.appendChild(groupDiv);

                groupChannels.forEach(ch => {
                    const el = document.createElement('div');
                    el.className = 'channel-item';
                    el.id = `ch-${ch.index}`;
                    el.onclick = () => playChannel(ch.index);
                    el.innerHTML = `
                        <i class="bi bi-play-circle-fill" style="margin-right:10px; opacity:0.5;"></i>
                        <span>${ch.name}</span>
                    `;
                    container.appendChild(el);
                });
            }
        }

        function playChannel(index) {
            const ch = allChannels[index];
            if (!ch) return;

            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`ch-${index}`);
            if (activeEl) {
                activeEl.classList.add('active');
                activeEl.scrollIntoView({ block: 'center', behavior: 'smooth' });
            }

            document.getElementById('currentChannelName').textContent = ch.name;

            const useProxy = document.getElementById('useProxy').checked;
            const playUrl = useProxy ? `/api/proxy?url=${encodeURIComponent(ch.url)}` : ch.url;
            const video = document.getElementById('video');

            if (window.hlsPlayer) { window.hlsPlayer.destroy(); window.hlsPlayer = null; }
            if (window.mpegtsPlayer) { window.mpegtsPlayer.destroy(); window.mpegtsPlayer = null; }

            const isMpegTs = playUrl.includes('/live') || playUrl.includes('.ts') || playUrl.includes('.flv') || playUrl.includes('/rtp/') || playUrl.includes('/udp/');

            if (isMpegTs && mpegts.getFeatureList().mseLivePlayback) {
                console.log("Mode: mpegts.js");
                window.mpegtsPlayer = mpegts.createPlayer({ type: 'mpegts', isLive: true, url: playUrl });
                window.mpegtsPlayer.attachMediaElement(video);
                window.mpegtsPlayer.load();
                window.mpegtsPlayer.play().catch(e => console.log(e));
            } else if (Hls.isSupported()) {
                console.log("Mode: hls.js");
                window.hlsPlayer = new Hls();
                window.hlsPlayer.loadSource(playUrl);
                window.hlsPlayer.attachMedia(video);
                window.hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play().catch(e => console.log(e));
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                console.log("Mode: native");
                video.src = playUrl;
                video.play().catch(e => console.log(e));
            }

            loadChannelEPG(ch);
            
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').style.display = 'none';
            }
        }

        function setEPG() {
            const url = document.getElementById('epgUrl').value.trim();
            if (!url) return;
            localStorage.setItem('epg_url', url);
            fetch('/api/epg/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(r => r.json())
            .then(d => {
                if (d.error) alert('EPG 错误: ' + d.error);
                else {
                    alert(d.message);
                    const current = document.querySelector('.channel-item.active');
                    if (current) {
                        const idx = parseInt(current.id.replace('ch-', ''));
                        loadChannelEPG(allChannels[idx]);
                    }
                }
            });
        }

        function loadChannelEPG(channel) {
            const container = document.getElementById('epgPanel');
            container.innerHTML = '<div style="padding:20px; text-align:center;"><div class="spinner-border spinner-border-sm text-secondary"></div> 正在查询...</div>';

            const params = new URLSearchParams({ name: channel.name, id: channel.id || '' });

            fetch(`/api/epg/channel?${params}`)
                .then(r => r.json())
                .then(data => {
                    const programs = data.programs;
                    if (!programs || programs.length === 0) {
                        container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">暂无节目信息</div>';
                        return;
                    }

                    container.innerHTML = '';
                    const now = new Date();
                    let activeEl = null;

                    programs.forEach(p => {
                        const row = document.createElement('div');
                        row.className = 'program-item';
                        
                        const startDate = parseXMLTVDate(p.start);
                        const endDate = parseXMLTVDate(p.stop);
                        let timeStr = startDate ? startDate.toTimeString().substr(0, 5) : "??:??";

                        if (startDate && endDate && now >= startDate && now < endDate) {
                            row.classList.add('current-program');
                            row.innerHTML = `
                                <div class="program-time">${timeStr} <span class="badge bg-primary" style="font-size:0.6em; vertical-align:text-top;">直播中</span></div>
                                <div class="program-title">${p.title}</div>
                            `;
                            activeEl = row;
                        } else {
                            row.innerHTML = `
                                <div class="program-time">${timeStr}</div>
                                <div class="program-title">${p.title}</div>
                            `;
                        }
                        container.appendChild(row);
                    });

                    if (activeEl) setTimeout(() => activeEl.scrollIntoView({ block: 'center', behavior: 'smooth' }), 100);
                });
        }

        function filterChannels(query) {
            const list = document.querySelectorAll('.channel-item');
            query = query.toLowerCase();
            list.forEach(el => {
                if (el.textContent.toLowerCase().includes(query)) el.style.display = 'flex';
                else el.style.display = 'none';
            });
        }

        function parseXMLTVDate(str) {
            if (!str || str.length < 14) return null;
            const year = parseInt(str.substr(0, 4));
            const month = parseInt(str.substr(4, 2)) - 1;
            const day = parseInt(str.substr(6, 2));
            const hour = parseInt(str.substr(8, 2));
            const minute = parseInt(str.substr(10, 2));
            const second = parseInt(str.substr(12, 2));
            return new Date(year, month, day, hour, minute, second);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        }
    </script>
</body>
</html>