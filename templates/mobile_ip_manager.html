{% extends "mobile_base.html" %}

{% block header_actions %}
<div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterBox">
        <i class="bi bi-funnel"></i>
    </button>
    <button class="btn btn-sm btn-danger" onclick="batchDelete()">
        <i class="bi bi-trash"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- 筛选栏 (折叠) -->
<div class="collapse mb-3" id="filterBox">
    <div class="card card-body p-3 bg-light">
        <input type="text" id="keyword" class="form-control mb-2" placeholder="搜索关键词..." value="{{ keyword }}">
        <div class="btn-group w-100 mb-2">
            <input type="radio" class="btn-check" name="ftype" id="t_all" value="all" {% if filter_type=='all' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="t_all">全部</label>
            <input type="radio" class="btn-check" name="ftype" id="t_mc" value="multicast" {% if filter_type=='multicast' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="t_mc">组播</label>
            <input type="radio" class="btn-check" name="ftype" id="t_ht" value="hotel" {% if filter_type=='hotel' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="t_ht">酒店</label>
        </div>
        <button class="btn btn-primary w-100" onclick="applyFilter()">应用筛选</button>
    </div>
</div>

<!-- IP列表 -->
<div id="ipList">
    {% for ip in ips %}
    <div class="card border-0 shadow-sm position-relative overflow-hidden">
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="form-check">
                    <input class="form-check-input ip-check" type="checkbox" value="{{ ip.ip_port }}">
                    <label class="form-check-label fw-bold text-dark ms-1" style="font-family: monospace; font-size: 1.1em">
                        {{ ip.ip_port }}
                    </label>
                </div>
                {% if ip.status == '新上线' %}
                <span class="badge bg-success rounded-pill" style="font-size: 0.7em">NEW</span>
                {% elif '存活' in ip.status %}
                <span class="badge bg-primary rounded-pill" style="font-size: 0.7em">LIVE</span>
                {% else %}
                <span class="badge bg-danger rounded-pill" style="font-size: 0.7em">OFF</span>
                {% endif %}
            </div>

            <div class="d-flex justify-content-between text-muted small mb-3">
                <span><i class="bi bi-geo-alt"></i> {{ ip.province_cn }} {{ ip.isp }}</span>
                <span><i class="bi bi-speedometer2"></i> {{ ip.speed }} MB/s</span>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-light flex-grow-1 text-primary" onclick="copyLink('{{ ip.ip_port }}')">
                    <i class="bi bi-clipboard"></i> 复制
                </button>
                <a href="/player?url=/playlist/txt/{{ ip.ip_port }}" target="_blank" class="btn btn-sm btn-light flex-grow-1 text-success">
                    <i class="bi bi-play-circle"></i> 播放
                </a>
                <button class="btn btn-sm btn-light flex-grow-1 text-secondary" onclick='showChannels("{{ ip.channel_lists | replace("\n", "|") | replace("\"", "&quot;") }}")'>
                    <i class="bi bi-list-ul"></i> {{ ip.channel_count }}
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="bi bi-inbox display-1 text-light"></i>
        <p class="mt-3">暂无数据</p>
    </div>
    {% endfor %}
</div>

<!-- 分页 -->
{% if total_pages > 1 %}
<nav class="pb-5">
    <ul class="pagination pagination-sm justify-content-center">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('ip_manager', page=page-1, type=filter_type, keyword=keyword) }}">上一页</a>
        </li>
        <li class="page-item active"><span class="page-link">{{ page }} / {{ total_pages }}</span></li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('ip_manager', page=page+1, type=filter_type, keyword=keyword) }}">下一页</a>
        </li>
    </ul>
</nav>
{% endif %}

<script>
    function applyFilter() {
        const type = document.querySelector('input[name="ftype"]:checked').value;
        const kw = document.getElementById('keyword').value;
        location.href = `?page=1&type=${type}&keyword=${encodeURIComponent(kw)}`;
    }

    async function batchDelete() {
        const checked = Array.from(document.querySelectorAll('.ip-check:checked')).map(c => c.value);
        if(checked.length === 0) return alert('请先选择项目');
        
        if(await asyncSwalConfirm('批量删除', `确定删除 ${checked.length} 个IP?`)) {
            fetch('/api/delete_ips', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip_ports: checked })
            }).then(() => location.reload());
        }
    }

    function copyLink(ip) {
        const url = location.origin + '/playlist/txt/' + ip;
        navigator.clipboard.writeText(url).then(() => {
            const toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1500 });
            toast.fire({ icon: 'success', title: '链接已复制' });
        });
    }

    function showChannels(listStr) {
        let html = '<div class="text-start" style="max-height:60vh;overflow-y:auto">';
        if(listStr) {
            listStr.split('|').forEach(line => {
                const p = line.split(',');
                if(p.length) html += `<div class="border-bottom py-2 small">${p[0]}</div>`;
            });
        }
        html += '</div>';
        Swal.fire({ title: '频道预览', html: html, showConfirmButton: false, showCloseButton: true });
    }
</script>
{% endblock %}