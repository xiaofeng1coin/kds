{% extends "base.html" %}

{% block content %}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">IP 管理</h5>
        <div class="d-flex align-items-center">
            <!-- Filters -->
            <div class="d-flex align-items-center me-2">
                <select class="form-select form-select-sm me-1" id="filterType" style="width: auto;">
                    <option value="all" {% if filter_type=='all' %}selected{% endif %}>全部类型</option>
                    <option value="multicast" {% if filter_type=='multicast' %}selected{% endif %}>组播</option>
                    <option value="hotel" {% if filter_type=='hotel' %}selected{% endif %}>酒店</option>
                </select>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="searchKeyword" placeholder="搜索关键字..."
                        value="{{ keyword }}">
                    <button class="btn btn-outline-primary" type="button" onclick="applyFilters()">搜索</button>
                </div>
            </div>

            <button class="btn btn-sm btn-outline-danger me-2" id="deleteSelectedBtn">批量删除</button>
            <select class="form-select form-select-sm me-2" style="width: auto;" id="pageSizeSelect"
                onchange="changePageSize(this.value)">
                <option value="10" {% if per_page==10 %}selected{% endif %}>10 / 页</option>
                <option value="20" {% if per_page==20 %}selected{% endif %}>20 / 页</option>
                <option value="50" {% if per_page==50 %}selected{% endif %}>50 / 页</option>
                <option value="100" {% if per_page==100 %}selected{% endif %}>100 / 页</option>
            </select>
            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">刷新列表</button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox"
                                onclick="toggleSelectAll()"></th>
                        <th>IP:端口</th>
                        <th>类型</th>
                        <th>来源</th>
                        <th>运营商</th>
                        <th>速度</th>

                        <th>节目数</th> <!-- Moved here or add new, let's add new -->

                        <th>状态</th>
                        <th>上线时间</th>
                        <th>省份</th>
                        <th>失效次数</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ip in ips %}
                    <tr>
                        <td><input type="checkbox" class="ip-checkbox" value="{{ ip.ip_port }}"></td>
                        <td class="fw-bold">{{ ip.ip_port }}</td>
                        <td>
                            {% if ip.type == 'hotel' %}
                            <span class="badge bg-warning text-dark">酒店</span>
                            {% else %}
                            <span class="badge bg-info text-dark">组播</span>
                            {% endif %}
                        </td>
                        <td>{{ ip.source_type }}</td>
                        <td>{{ ip.isp or '-' }}</td>
                        <td>{{ ip.speed or '0' }} MB/s</td>

                        <!-- Channel Count -->
                        <td>
                            {% if ip.channel_count > 0 %}
                            <a href="javascript:void(0)" class="text-decoration-none"
                                onclick='showChannels("{{ ip.ip_port }}", "{{ ip.channel_lists | replace("\n", "|") | replace("\"", "&quot;") }}")'>
                                {{ ip.channel_count }}
                            </a>
                            {% else %}
                            <span class="text-muted">0</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if ip.status == '新上线' %}
                            <span class="badge bg-success">新上线</span>
                            {% elif '存活' in ip.status %}
                            <span class="badge bg-warning text-dark">{{ ip.status }}</span>
                            {% else %}
                            <span class="badge bg-danger">{{ ip.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ ip.online_time }}</td>
                        <td>{{ ip.province_cn }}</td>
                        <td>{{ ip.failure_count }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary"
                                    onclick="copyLink('{{ ip.ip_port }}', 'txt', this)">TXT</button>
                                <button class="btn btn-outline-success"
                                    onclick="copyLink('{{ ip.ip_port }}', 'm3u', this)">M3U</button>
                                <a href="/player?url=/playlist/txt/{{ ip.ip_port }}" target="_blank"
                                    class="btn btn-outline-primary">播放</a>
                                <button class="btn btn-outline-danger"
                                    onclick="deleteIP('{{ ip.ip_port }}')">删除</button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center py-5 text-muted">暂无数据，请前往采集页面获取数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="p-3 d-flex justify-content-between align-items-center">
            <div class="text-muted small">共 {{ total_items }} 条数据 ({{ total_pages }} 页)</div>
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link"
                            href="{{ url_for('ip_manager', page=page-1, per_page=per_page, type=filter_type, keyword=keyword) }}">上一页</a>
                    </li>

                    {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                    {% elif p < 4 or p> total_pages - 3 or (p > page - 2 and p < page + 2) %} <li class="page-item"><a
                                class="page-link"
                                href="{{ url_for('ip_manager', page=p, per_page=per_page, type=filter_type, keyword=keyword) }}">{{
                                p
                                }}</a></li>
                            {% elif p == 4 or p == total_pages - 3 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                            {% endfor %}

                            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                                <a class="page-link"
                                    href="{{ url_for('ip_manager', page=page+1, per_page=per_page, type=filter_type, keyword=keyword) }}">下一页</a>
                            </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="channelModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">节目列表</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>节目名</th>
                            <th>URL</th>
                        </tr>
                    </thead>
                    <tbody id="channelTableBody">
                        <!-- Content filled by JS -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


<!-- Toast Notification -->
<div id="copyToast" class="alert alert-success shadow px-4 py-2" role="alert"
    style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1055; display: none; opacity: 0; transition: opacity 0.5s;">
    复制成功
</div>

<script>
    function showToast(message, isError = false) {
        const toast = document.getElementById('copyToast');
        toast.innerText = message;
        toast.className = isError ? 'alert alert-danger shadow px-4 py-2' : 'alert alert-success shadow px-4 py-2';
        toast.style.display = 'block';

        // Trigger reflow
        toast.offsetHeight;

        toast.style.opacity = '1';

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 500); // Wait for transition
        }, 3000);
    }

    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.ip-checkbox');
        const selectAll = document.getElementById('selectAllCheckbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
    }

    // Bulk Delete
    document.getElementById('deleteSelectedBtn').addEventListener('click', function () {
        const selected = Array.from(document.querySelectorAll('.ip-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            showToast('请至少选择一项进行删除', true);
            return;
        }

        if (confirm('确定要删除选中的 ' + selected.length + ' 个IP吗?')) {
            fetch('/api/delete_ips', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip_ports: selected })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        showToast('删除失败', true);
                    }
                });
        }
    });

    function deleteIP(ipPort) {
        if (confirm('确定要删除 ' + ipPort + ' 吗?')) {
            fetch('/api/delete_ips', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip_ports: [ipPort] }) // Use list format
            }).then(() => location.reload());
        }
    }

    function changePageSize(size) {
        const url = new URL(window.location.href);
        url.searchParams.set('per_page', size);
        url.searchParams.set('page', 1);
        // Keep existing filters
        window.location.href = url.toString();
    }

    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const keyword = document.getElementById('searchKeyword').value;

        const url = new URL(window.location.href);
        url.searchParams.set('page', 1); // Reset to page 1
        url.searchParams.set('type', type);
        url.searchParams.set('keyword', keyword);

        window.location.href = url.toString();
    }

    // Show Channels Modal
    function showChannels(ipPort, channelListStr) {
        const tbody = document.getElementById('channelTableBody');
        tbody.innerHTML = '';

        // Store current IP Port on modal for copy function
        document.getElementById('channelModal').dataset.ipPort = ipPort;

        if (!channelListStr) {
            // Still show modal if empty
        } else {
            const list = channelListStr.split('|'); // Split by pipe which we replaced newline with
            list.forEach(item => {
                const parts = item.split(',');
                if (parts.length >= 2) {
                    const name = parts[0];
                    const url = parts.slice(1).join(','); // Join back if URL contained commas

                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${name}</td><td class="text-break">${url}</td>`;
                    tbody.appendChild(tr);
                }
            });
        }

        var myModal = new bootstrap.Modal(document.getElementById('channelModal'));
        myModal.show();
    }

    function copyLink(ipPort, fmt, btnElement) {
        if (!ipPort) {
            showToast("无法获取当前IP信息", true);
            return;
        }

        const link = window.location.origin + '/playlist/' + fmt + '/' + ipPort;

        // Visual feedback
        const originalText = btnElement.innerText;
        const originalClass = btnElement.className;

        // Copy to Clipboard
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(link).then(() => {
                showToast("复制成功！\n" + link);
                // Button feedback
                btnElement.innerText = "已复制";
                btnElement.classList.replace('btn-outline-secondary', 'btn-success');
                btnElement.classList.replace('btn-outline-success', 'btn-success');

                setTimeout(() => {
                    btnElement.innerText = originalText;
                    btnElement.className = originalClass;
                }, 2000);

            }).catch(err => {
                console.error('Clipboard API failed: ', err);
                fallbackCopy(link);
            });
        } else {
            fallbackCopy(link);
        }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("复制成功！\n" + text);
        } catch (err) {
            showToast("复制失败，请手动复制。", true);
        }
        document.body.removeChild(textArea);
    }
</script>
{% endblock %}