{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-white border-0 py-3 d-flex flex-wrap align-items-center justify-content-between gap-3">
        <h5 class="mb-0 brand-font"><i class="bi bi-grid-3x3-gap-fill text-primary"></i> IP 资源矩阵</h5>
        
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <select class="form-select form-select-sm w-auto" id="filterType">
                <option value="all" {% if filter_type=='all' %}selected{% endif %}>全部源</option>
                <option value="multicast" {% if filter_type=='multicast' %}selected{% endif %}>组播</option>
                <option value="hotel" {% if filter_type=='hotel' %}selected{% endif %}>酒店</option>
            </select>
            
            <div class="input-group input-group-sm" style="width: 200px;">
                <input type="text" class="form-control" id="searchKeyword" placeholder="关键字搜索..." value="{{ keyword }}">
                <button class="btn btn-outline-primary" type="button" onclick="applyFilters()"><i class="bi bi-search"></i></button>
            </div>

            <div class="vr mx-2"></div>

            <button class="btn btn-sm btn-danger shadow-sm" id="deleteSelectedBtn">
                <i class="bi bi-trash"></i> 批量删除
            </button>
            
            <div class="btn-group btn-group-sm">
                <a href="{{ url_for('ip_manager', page=page, per_page=10, type=filter_type) }}" class="btn btn-outline-secondary {% if per_page==10 %}active{% endif %}">10</a>
                <a href="{{ url_for('ip_manager', page=page, per_page=50, type=filter_type) }}" class="btn btn-outline-secondary {% if per_page==50 %}active{% endif %}">50</a>
                <a href="{{ url_for('ip_manager', page=page, per_page=100, type=filter_type) }}" class="btn btn-outline-secondary {% if per_page==100 %}active{% endif %}">100</a>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4" style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAllCheckbox" onclick="toggleSelectAll()"></th>
                    <th>IP地址:端口</th>
                    <th>类型</th>
                    <th>地区 / 运营商</th>
                    <th>速度</th>
                    <th>频道数</th>
                    <th>状态</th>
                    <th>上线时间</th>
                    <th class="text-end pe-4">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for ip in ips %}
                <tr>
                    <td class="ps-4"><input type="checkbox" class="form-check-input ip-checkbox" value="{{ ip.ip_port }}"></td>
                    <td>
                        <span class="fw-bold text-dark">{{ ip.ip_port }}</span>
                    </td>
                    <td>
                        {% if ip.type == 'hotel' %}
                        <span class="badge bg-warning text-dark"><i class="bi bi-building"></i> 酒店</span>
                        {% else %}
                        <span class="badge bg-info text-dark"><i class="bi bi-broadcast"></i> 组播</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="small fw-bold">{{ ip.province_cn }}</div>
                        <div class="text-muted" style="font-size: 0.75em">{{ ip.isp or '未知' }}</div>
                    </td>
                    <td>
                        {% if ip.speed %}
                        <div class="progress" style="height: 6px; width: 60px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ (ip.speed|float / 10) * 100 }}%"></div>
                        </div>
                        <span class="small text-muted">{{ ip.speed }} MB/s</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if ip.channel_count > 0 %}
                        <button class="btn btn-sm btn-light border rounded-pill px-3" 
                                onclick='showChannels("{{ ip.ip_port }}", "{{ ip.channel_lists | replace("\n", "|") | replace("\"", "&quot;") }}")'>
                            {{ ip.channel_count }}
                        </button>
                        {% else %}
                        <span class="text-muted">0</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if ip.status == '新上线' %}
                        <span class="badge rounded-pill bg-success">新上线</span>
                        {% elif '存活' in ip.status %}
                        <span class="badge rounded-pill bg-primary">存活</span>
                        {% else %}
                        <span class="badge rounded-pill bg-danger">离线 ({{ ip.failure_count }})</span>
                        {% endif %}
                    </td>
                    <td class="text-muted small">{{ ip.online_time }}</td>
                    <td class="text-end pe-4">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-dark" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="copyLink('{{ ip.ip_port }}', 'txt')"><i class="bi bi-file-text me-2"></i>复制 TXT</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="copyLink('{{ ip.ip_port }}', 'm3u')"><i class="bi bi-collection-play me-2"></i>复制 M3U</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/player?url=/playlist/txt/{{ ip.ip_port }}" target="_blank"><i class="bi bi-play-circle me-2"></i>在线播放</a></li>
                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteIP('{{ ip.ip_port }}')"><i class="bi bi-trash me-2"></i>删除</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox display-4 d-block mb-3"></i>
                        暂无数据，请前往采集中心
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页 -->
    {% if total_pages > 1 %}
    <div class="card-footer bg-white border-0 py-3">
        <nav>
            <ul class="pagination justify-content-center pagination-sm mb-0">
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('ip_manager', page=page-1, per_page=per_page, type=filter_type, keyword=keyword) }}">上一页</a>
                </li>
                <li class="page-item active"><span class="page-link">{{ page }} / {{ total_pages }}</span></li>
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('ip_manager', page=page+1, per_page=per_page, type=filter_type, keyword=keyword) }}">下一页</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- 频道列表弹窗 -->
<div class="modal fade" id="channelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title">节目列表</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="list-group list-group-flush" id="channelListBody">
                    <!-- JS 填充 -->
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.ip-checkbox');
        const selectAll = document.getElementById('selectAllCheckbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
    }

    document.getElementById('deleteSelectedBtn').addEventListener('click', async function () {
        const selected = Array.from(document.querySelectorAll('.ip-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) return Swal.fire('提示', '请先选择需要删除的项', 'info');

        const confirmed = await asyncSwalConfirm('确认删除?', `将删除 ${selected.length} 个IP地址，不可恢复。`);
        if(confirmed) {
            fetch('/api/delete_ips', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip_ports: selected })
            }).then(() => location.reload());
        }
    });

    async function deleteIP(ipPort) {
        const confirmed = await asyncSwalConfirm('删除此IP?', ipPort);
        if (confirmed) {
            fetch('/api/delete_ips', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip_ports: [ipPort] })
            }).then(() => location.reload());
        }
    }

    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const keyword = document.getElementById('searchKeyword').value;
        const url = new URL(window.location.href);
        url.searchParams.set('page', 1);
        url.searchParams.set('type', type);
        url.searchParams.set('keyword', keyword);
        window.location.href = url.toString();
    }

    function showChannels(ipPort, listStr) {
        const listBody = document.getElementById('channelListBody');
        listBody.innerHTML = '';
        if (listStr) {
            const list = listStr.split('|');
            list.forEach(item => {
                const parts = item.split(',');
                if (parts.length >= 2) {
                    listBody.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${parts[0]}</span>
                            <span class="badge bg-light text-muted fw-normal">链接</span>
                        </li>
                    `;
                }
            });
        }
        new bootstrap.Modal(document.getElementById('channelModal')).show();
    }

    function copyLink(ipPort, fmt) {
        const link = window.location.origin + '/playlist/' + fmt + '/' + ipPort;
        navigator.clipboard.writeText(link).then(() => {
            Swal.fire({
                icon: 'success',
                title: '已复制',
                text: link,
                toast: true,
                position: 'top',
                showConfirmButton: false,
                timer: 2000
            });
        });
    }
</script>
{% endblock %}