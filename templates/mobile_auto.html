{% extends "mobile_base.html" %}

{% block content %}
<ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded-pill shadow-sm" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill active" id="pills-manual-tab" data-bs-toggle="pill" data-bs-target="#pills-manual" type="button">æ‰‹åŠ¨é‡‡é›†</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill" id="pills-auto-tab" data-bs-toggle="pill" data-bs-target="#pills-auto" type="button">è‡ªåŠ¨ä»»åŠ¡</button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent">
    <!-- æ‰‹åŠ¨é‡‡é›† -->
    <div class="tab-pane fade show active" id="pills-manual" role="tabpanel">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body text-center py-4">
                <div id="statusIcon" class="mb-2">
                    <i class="bi bi-cpu display-4 text-muted"></i>
                </div>
                <h6 id="statusText" class="fw-bold mb-0">ç³»ç»Ÿç©ºé—²</h6>
                <small class="text-muted" id="statusSub">ç­‰å¾…æŒ‡ä»¤</small>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <form id="mobileCollectForm">
                    <div class="mb-3">
                        <label class="form-label small text-muted fw-bold">æºç±»å‹</label>
                        <select class="form-select" id="apiType">
                            <option value="all">ğŸš€ å…¨éƒ¨ (All)</option>
                            <option value="multicast">ğŸ“¡ ç»„æ’­ (Multicast)</option>
                            <option value="hotel">ğŸ¨ é…’åº— (Hotel)</option>
                        </select>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted fw-bold">é¡µæ•°</label>
                            <input type="number" class="form-control text-center" id="pages" value="5">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted fw-bold">æ—¥æœŸ (å¯é€‰)</label>
                            <input type="date" class="form-control text-center" id="date">
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary py-2" id="startBtn" onclick="startCollection()">
                            <i class="bi bi-play-fill"></i> å¼€å§‹é‡‡é›†
                        </button>
                        <button type="button" class="btn btn-danger py-2" id="stopBtn" onclick="stopCollection()" disabled>
                            <i class="bi bi-stop-fill"></i> åœæ­¢
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ç®€æ˜“ç»ˆç«¯ -->
        <div class="card bg-dark text-light border-0 mt-3 shadow-sm">
            <div class="card-body p-2">
                <div id="logContainer" style="height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.4;">
                    <span class="text-muted">> Ready...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªåŠ¨ä»»åŠ¡é…ç½® -->
    <div class="tab-pane fade" id="pills-auto" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="fw-bold mb-3">è‡ªåŠ¨é‡‡é›†é…ç½®</h6>
                <div class="mb-3">
                    <label class="form-label small text-muted">é»˜è®¤ç±»å‹</label>
                    <select class="form-select" id="autoApiType">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="multicast">ç»„æ’­</option>
                        <option value="hotel">é…’åº—</option>
                    </select>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label small text-muted">é‡‡é›†é¡µæ•°</label>
                        <input type="number" class="form-control" id="autoPages">
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted">å›æº¯å¤©æ•°</label>
                        <input type="number" class="form-control" id="autoDays">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small text-muted">å®šæ—¶ä»»åŠ¡ (24håˆ¶)</label>
                    <div id="scheduleContainer" class="d-flex flex-column gap-2">
                        <!-- JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-2 dashed-border" onclick="addScheduleInput()">
                        <i class="bi bi-plus-lg"></i> æ·»åŠ æ—¶é—´ç‚¹
                    </button>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="saveAutoSettings()">ä¿å­˜é…ç½®</button>
                    <button class="btn btn-info text-white" onclick="showHistory()"><i class="bi bi-clock-history"></i> è¿è¡Œå†å²</button>
                </div>
                <input type="hidden" id="logRetentionDays" value="7">
            </div>
        </div>
    </div>
</div>

<style>
    .dashed-border { border: 1px dashed #ced4da; }
</style>

<script>
    document.getElementById('date').valueAsDate = new Date();

    // åŠ è½½è‡ªåŠ¨è®¾ç½®
    function loadAutoSettings() {
        fetch('/api/get_settings').then(r => r.json()).then(data => {
            document.getElementById('autoApiType').value = data.auto_api_type;
            document.getElementById('autoPages').value = data.auto_pages;
            document.getElementById('autoDays').value = data.auto_days;
            document.getElementById('logRetentionDays').value = data.log_retention_days;
            
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            (data.auto_schedules || []).forEach(time => addScheduleInput(time));
        });
    }
    
    // åˆå§‹åŒ–åŠ è½½
    loadAutoSettings();

    function addScheduleInput(value = '') {
        const container = document.getElementById('scheduleContainer');
        if (container.children.length >= 5) return Swal.fire('æç¤º', 'æœ€å¤šæ·»åŠ 5ä¸ªä»»åŠ¡', 'warning');
        
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `
            <span class="input-group-text bg-white"><i class="bi bi-clock"></i></span>
            <input type="time" class="form-control" value="${value}">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
                <i class="bi bi-trash"></i>
            </button>
        `;
        container.appendChild(div);
    }

    function saveAutoSettings() {
        const schedules = Array.from(document.querySelectorAll('#scheduleContainer input')).map(i => i.value).filter(v=>v);
        const payload = {
            auto_api_type: document.getElementById('autoApiType').value,
            auto_pages: document.getElementById('autoPages').value,
            auto_days: document.getElementById('autoDays').value,
            log_retention_days: document.getElementById('logRetentionDays').value,
            auto_schedules: schedules
        };
        fetch('/api/save_settings', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        }).then(r=>r.json()).then(d => Swal.fire('ä¿å­˜æˆåŠŸ', d.message, 'success'));
    }

    function showHistory() {
        fetch('/api/get_history_logs').then(r=>r.json()).then(data => {
            let html = '<div class="list-group list-group-flush text-start">';
            if(data.logs.length === 0) html += '<div class="p-3 text-center text-muted">æš‚æ— å†å²</div>';
            else {
                data.logs.forEach(log => {
                    html += `
                        <div class="list-group-item px-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${log.date} ${log.collection_time}</small>
                                <span class="badge bg-light text-dark border">å­˜æ´» ${log.stock_ip}</span>
                            </div>
                            <div class="small mt-1">
                                <span class="text-success">æ–°å¢ +${log.collected_ip}</span> | 
                                <span class="text-primary">æ›´æ–° ${log.updated_ip}</span>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            Swal.fire({ title: 'è¿è¡Œå†å²', html: html, showCloseButton: true });
        });
    }

    // é‡‡é›†é€»è¾‘
    function startCollection() {
        const btn = document.getElementById('startBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> å¯åŠ¨ä¸­...';
        
        const payload = {
            api_type: document.getElementById('apiType').value,
            pages: document.getElementById('pages').value,
            date: document.getElementById('date').value
        };

        fetch('/api/collect', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        }).then(r => r.json()).then(data => {
            btn.innerHTML = 'è¿è¡Œä¸­...';
            document.getElementById('stopBtn').disabled = false;
            updateStatus('running');
            startLogPolling();
        });
    }

    async function stopCollection() {
        if(await asyncSwalConfirm('åœæ­¢ä»»åŠ¡?', 'å°†ä¸­æ–­å½“å‰è¿›ç¨‹')) {
            fetch('/api/stop_collection', { method: 'POST' });
        }
    }

    let pollInterval;
    function startLogPolling() {
        const logDiv = document.getElementById('logContainer');
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(() => {
            fetch('/api/logs').then(res => res.json()).then(data => {
                if (data.logs) {
                    logDiv.innerHTML = data.logs.map(l => {
                        let c = '#ccc';
                        if(l.includes('Error')) c = '#ff6b6b';
                        else if(l.includes('Success')) c = '#2ecc71';
                        else if(l.includes('Processing')) c = '#feca57';
                        return `<div style="color:${c}">${l}</div>`;
                    }).join('');
                    logDiv.scrollTop = logDiv.scrollHeight;
                    
                    const last = data.logs[data.logs.length-1] || "";
                    if (last.includes("ç»“æŸ") || last.includes("å‡ºé”™") || last.includes("åœæ­¢")) {
                        clearInterval(pollInterval);
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').innerHTML = '<i class="bi bi-play-fill"></i> å¼€å§‹é‡‡é›†';
                        document.getElementById('stopBtn').disabled = true;
                        updateStatus('idle');
                    }
                }
            });
        }, 1000);
    }

    function updateStatus(state) {
        const t = document.getElementById('statusText');
        const i = document.getElementById('statusIcon');
        if(state === 'running') {
            i.innerHTML = '<div class="spinner-grow text-primary"></div>';
            t.innerHTML = 'ä»»åŠ¡è¿è¡Œä¸­'; t.className = 'fw-bold mb-0 text-primary';
        } else {
            i.innerHTML = '<i class="bi bi-cpu display-4 text-muted"></i>';
            t.innerHTML = 'ç³»ç»Ÿç©ºé—²'; t.className = 'fw-bold mb-0';
        }
    }
</script>
{% endblock %}